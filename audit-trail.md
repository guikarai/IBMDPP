# Audit trail

An audit trail (also called audit log) is a security-relevant chronological record, set of records, and/or destination and source of records that provide documentary evidence of the sequence of activities that have affected at any time a specific operation, procedure, or event.

IBM Data Privacy Passports plays a critical roles enforcing/protecting the data. 
Moreover, IBM Data Privacy Passports is admnistrated by Admin users in charge of:
* creating the policy
* creating routes to DBMS using DMBS's valid users and credentials
* co-signing a policy
* deploying a policy

Such activities needs to be logged acurrately for both security and compliance reasons. Let's access to some audit logs.

## 1. Query audit

IBM Data Privacy Passports is based on a engine accepting some command lines. One of this command line **"@dp show metrics"** dislayed the latest queries addressed and executed by IBM Data Privacy Passports.

:computer: Issue the command shown below to query as an IBM Data Privacy Passports Administrator the query log:
```
beeline -u "jdbc:hive2://10.3.58.108:10010" -n DAUser -p XXXXX -e "@dp show metrics";
```
Expected output is:
```
Connecting to jdbc:hive2://10.3.58.108:10010
Connected to: Spark SQL (version 2.2.2)
Driver: Hive JDBC (version 1.2.1)
Transaction isolation: TRANSACTION_REPEATABLE_READ
+---------------------------------------------------------------+----------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------+-------------------------------+--+
|                               q                               |  result  |                                                                                                                                                                                                                                                                                         metrics                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                session                                                                                                                                                                                                 |           startTime           |          finishTime           |
+---------------------------------------------------------------+----------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------+-------------------------------+--+
| select * from awspostgresql.protected_app1_customer LIMIT 10  | SUCCESS  | {"dataUsedForSchemaInference":220,"enforcedDataElement(s)":160,"ignoredPassport(s)":80,"lookupTableComputed":0,"lookupTableFromDFSCache":0,"lookupTableFromInMemoryCache":0,"numberOfChainedDEK(s)ForEnforcement":0,"numberOfChainedDEK(s)ForProtection":0,"numberOfKEK(s)ForProtection":0,"numberOfKEK(s)ForUnprotection":0,"numberOfLocalDEK(s)ForEnforcement":0,"numberOfLocalDEK(s)ForProtection":0,"numberOfOneTimeDEK(s)ForProtection":0,"numberOfQueryDEK(s)ForProtection":0,"numberOfSharedDEK(s)ForProtection":0,"protectedDataElement(s)":0,"unprotectedDataElement(s)":110}   | {"effectiveSenderUID":"SC1.App1","effectiveTargetUID":"SC1.App1","effectiveTrustZoneUIDs":"[SC1.App1, SC1.TZ1]","failSilently":false,"mode":"Enforcement","permissions":"[]","senderID":null,"serviceUser":{"authenticationMethod":"SIMPLE","groups":"datapass, wheel","name":"datapass"},"targetID":null,"user":{"authenticationMethod":"SIMPLE","groups":"","name":"App1"},"writeMode":"Intrinsic"}  | Fri Mar 13 11:57:21 CET 2020  | Fri Mar 13 11:57:33 CET 2020  |
| select * from awspostgresql.protected_app1_customer LIMIT 10  | SUCCESS  | {"dataUsedForSchemaInference":220,"enforcedDataElement(s)":220,"ignoredPassport(s)":110,"lookupTableComputed":0,"lookupTableFromDFSCache":0,"lookupTableFromInMemoryCache":0,"numberOfChainedDEK(s)ForEnforcement":0,"numberOfChainedDEK(s)ForProtection":0,"numberOfKEK(s)ForProtection":0,"numberOfKEK(s)ForUnprotection":0,"numberOfLocalDEK(s)ForEnforcement":0,"numberOfLocalDEK(s)ForProtection":0,"numberOfOneTimeDEK(s)ForProtection":0,"numberOfQueryDEK(s)ForProtection":0,"numberOfSharedDEK(s)ForProtection":0,"protectedDataElement(s)":0,"unprotectedDataElement(s)":110}  | {"effectiveSenderUID":"SC1.DA","effectiveTargetUID":"SC1.DA","effectiveTrustZoneUIDs":"[SC1.DA]","failSilently":false,"mode":"Enforcement","permissions":"[]","senderID":null,"serviceUser":{"authenticationMethod":"SIMPLE","groups":"datapass, wheel","name":"datapass"},"targetID":null,"user":{"authenticationMethod":"SIMPLE","groups":"","name":"DA"},"writeMode":"Intrinsic"}                   | Fri Mar 13 11:56:00 CET 2020  | Fri Mar 13 11:56:12 CET 2020  |
| select * from awspostgresql.protected_app1_customer LIMIT 10  | SUCCESS  | {"dataUsedForSchemaInference":220,"enforcedDataElement(s)":0,"ignoredPassport(s)":0,"lookupTableComputed":0,"lookupTableFromDFSCache":0,"lookupTableFromInMemoryCache":0,"numberOfChainedDEK(s)ForEnforcement":0,"numberOfChainedDEK(s)ForProtection":0,"numberOfKEK(s)ForProtection":0,"numberOfKEK(s)ForUnprotection":0,"numberOfLocalDEK(s)ForEnforcement":0,"numberOfLocalDEK(s)ForProtection":0,"numberOfOneTimeDEK(s)ForProtection":0,"numberOfQueryDEK(s)ForProtection":0,"numberOfSharedDEK(s)ForProtection":0,"protectedDataElement(s)":0,"unprotectedDataElement(s)":110}      | {"effectiveSenderUID":"SC1.DO","effectiveTargetUID":"SC1.DO","effectiveTrustZoneUIDs":"[SC1.DO]","failSilently":false,"mode":"Enforcement","permissions":"[]","senderID":"DO","serviceUser":{"authenticationMethod":"SIMPLE","groups":"datapass, wheel","name":"datapass"},"targetID":"DO","user":{"authenticationMethod":"SIMPLE","groups":"","name":"DO"},"writeMode":"Intrinsic"}                   | Fri Mar 13 11:55:12 CET 2020  | Fri Mar 13 11:55:24 CET 2020  |
| select * from awspostgresql.protected_app1_customer LIMIT 10  | SUCCESS  | {"dataUsedForSchemaInference":220,"enforcedDataElement(s)":0,"ignoredPassport(s)":0,"lookupTableComputed":0,"lookupTableFromDFSCache":0,"lookupTableFromInMemoryCache":0,"numberOfChainedDEK(s)ForEnforcement":0,"numberOfChainedDEK(s)ForProtection":0,"numberOfKEK(s)ForProtection":0,"numberOfKEK(s)ForUnprotection":0,"numberOfLocalDEK(s)ForEnforcement":0,"numberOfLocalDEK(s)ForProtection":0,"numberOfOneTimeDEK(s)ForProtection":0,"numberOfQueryDEK(s)ForProtection":0,"numberOfSharedDEK(s)ForProtection":0,"protectedDataElement(s)":0,"unprotectedDataElement(s)":110}      | {"effectiveSenderUID":"SC1.DO","effectiveTargetUID":"SC1.DO","effectiveTrustZoneUIDs":"[SC1.DO]","failSilently":false,"mode":"Enforcement","permissions":"[]","senderID":"DO","serviceUser":{"authenticationMethod":"SIMPLE","groups":"datapass, wheel","name":"datapass"},"targetID":"DO","user":{"authenticationMethod":"SIMPLE","groups":"","name":"DO"},"writeMode":"Intrinsic"}                   | Fri Mar 13 11:46:42 CET 2020  | Fri Mar 13 11:46:55 CET 2020  |
| select * from awspostgresql.customer LIMIT 10                 | SUCCESS  | {"dataUsedForSchemaInference":0,"enforcedDataElement(s)":80,"ignoredPassport(s)":0,"lookupTableComputed":0,"lookupTableFromDFSCache":0,"lookupTableFromInMemoryCache":0,"numberOfChainedDEK(s)ForEnforcement":0,"numberOfChainedDEK(s)ForProtection":0,"numberOfKEK(s)ForProtection":0,"numberOfKEK(s)ForUnprotection":0,"numberOfLocalDEK(s)ForEnforcement":0,"numberOfLocalDEK(s)ForProtection":0,"numberOfOneTimeDEK(s)ForProtection":0,"numberOfQueryDEK(s)ForProtection":0,"numberOfSharedDEK(s)ForProtection":0,"protectedDataElement(s)":0,"unprotectedDataElement(s)":0}         | {"effectiveSenderUID":"SC1.App1","effectiveTargetUID":"SC1.App1","effectiveTrustZoneUIDs":"[SC1.App1, SC1.TZ1]","failSilently":false,"mode":"Enforcement","permissions":"[]","senderID":null,"serviceUser":{"authenticationMethod":"SIMPLE","groups":"datapass, wheel","name":"datapass"},"targetID":null,"user":{"authenticationMethod":"SIMPLE","groups":"","name":"App1"},"writeMode":"Intrinsic"}  | Fri Mar 13 11:26:29 CET 2020  | Fri Mar 13 11:26:29 CET 2020  |
| select * from awspostgresql.customer LIMIT 10                 | SUCCESS  | {"dataUsedForSchemaInference":0,"enforcedDataElement(s)":110,"ignoredPassport(s)":0,"lookupTableComputed":0,"lookupTableFromDFSCache":0,"lookupTableFromInMemoryCache":0,"numberOfChainedDEK(s)ForEnforcement":0,"numberOfChainedDEK(s)ForProtection":0,"numberOfKEK(s)ForProtection":0,"numberOfKEK(s)ForUnprotection":0,"numberOfLocalDEK(s)ForEnforcement":0,"numberOfLocalDEK(s)ForProtection":0,"numberOfOneTimeDEK(s)ForProtection":0,"numberOfQueryDEK(s)ForProtection":0,"numberOfSharedDEK(s)ForProtection":0,"protectedDataElement(s)":0,"unprotectedDataElement(s)":0}        | {"effectiveSenderUID":"SC1.DA","effectiveTargetUID":"SC1.DA","effectiveTrustZoneUIDs":"[SC1.DA]","failSilently":false,"mode":"Enforcement","permissions":"[]","senderID":null,"serviceUser":{"authenticationMethod":"SIMPLE","groups":"datapass, wheel","name":"datapass"},"targetID":null,"user":{"authenticationMethod":"SIMPLE","groups":"","name":"DA"},"writeMode":"Intrinsic"}                   | Fri Mar 13 11:25:53 CET 2020  | Fri Mar 13 11:25:54 CET 2020  |
| select * from awspostgresql.customer LIMIT 10                 | SUCCESS  | {"dataUsedForSchemaInference":0,"enforcedDataElement(s)":0,"ignoredPassport(s)":0,"lookupTableComputed":0,"lookupTableFromDFSCache":0,"lookupTableFromInMemoryCache":0,"numberOfChainedDEK(s)ForEnforcement":0,"numberOfChainedDEK(s)ForProtection":0,"numberOfKEK(s)ForProtection":0,"numberOfKEK(s)ForUnprotection":0,"numberOfLocalDEK(s)ForEnforcement":0,"numberOfLocalDEK(s)ForProtection":0,"numberOfOneTimeDEK(s)ForProtection":0,"numberOfQueryDEK(s)ForProtection":0,"numberOfSharedDEK(s)ForProtection":0,"protectedDataElement(s)":0,"unprotectedDataElement(s)":0}          | {"effectiveSenderUID":"SC1.DO","effectiveTargetUID":"SC1.DO","effectiveTrustZoneUIDs":"[SC1.DO]","failSilently":false,"mode":"Enforcement","permissions":"[]","senderID":"DO","serviceUser":{"authenticationMethod":"SIMPLE","groups":"datapass, wheel","name":"datapass"},"targetID":"DO","user":{"authenticationMethod":"SIMPLE","groups":"","name":"DO"},"writeMode":"Intrinsic"}                   | Fri Mar 13 11:25:08 CET 2020  | Fri Mar 13 11:25:09 CET 2020  |
| select * from LoZpostgresql.customer LIMIT 10                 | SUCCESS  | {"dataUsedForSchemaInference":0,"enforcedDataElement(s)":0,"ignoredPassport(s)":0,"lookupTableComputed":0,"lookupTableFromDFSCache":0,"lookupTableFromInMemoryCache":0,"numberOfChainedDEK(s)ForEnforcement":0,"numberOfChainedDEK(s)ForProtection":0,"numberOfKEK(s)ForProtection":0,"numberOfKEK(s)ForUnprotection":0,"numberOfLocalDEK(s)ForEnforcement":0,"numberOfLocalDEK(s)ForProtection":0,"numberOfOneTimeDEK(s)ForProtection":0,"numberOfQueryDEK(s)ForProtection":0,"numberOfSharedDEK(s)ForProtection":0,"protectedDataElement(s)":0,"unprotectedDataElement(s)":0}          | {"effectiveSenderUID":"SC1.DO","effectiveTargetUID":"SC1.DO","effectiveTrustZoneUIDs":"[SC1.DO]","failSilently":false,"mode":"Enforcement","permissions":"[]","senderID":null,"serviceUser":{"authenticationMethod":"SIMPLE","groups":"datapass, wheel","name":"datapass"},"targetID":null,"user":{"authenticationMethod":"SIMPLE","groups":"","name":"DO"},"writeMode":"Intrinsic"}                   | Thu Mar 12 16:52:35 CET 2020  | Thu Mar 12 16:52:36 CET 2020  |
| select * from LoZpostgresql.customer LIMIT 10                 | SUCCESS  | {"dataUsedForSchemaInference":0,"enforcedDataElement(s)":0,"ignoredPassport(s)":0,"lookupTableComputed":0,"lookupTableFromDFSCache":0,"lookupTableFromInMemoryCache":0,"numberOfChainedDEK(s)ForEnforcement":0,"numberOfChainedDEK(s)ForProtection":0,"numberOfKEK(s)ForProtection":0,"numberOfKEK(s)ForUnprotection":0,"numberOfLocalDEK(s)ForEnforcement":0,"numberOfLocalDEK(s)ForProtection":0,"numberOfOneTimeDEK(s)ForProtection":0,"numberOfQueryDEK(s)ForProtection":0,"numberOfSharedDEK(s)ForProtection":0,"protectedDataElement(s)":0,"unprotectedDataElement(s)":0}          | {"effectiveSenderUID":"SC1.DO","effectiveTargetUID":"SC1.DO","effectiveTrustZoneUIDs":"[SC1.DO]","failSilently":false,"mode":"Enforcement","permissions":"[]","senderID":null,"serviceUser":{"authenticationMethod":"SIMPLE","groups":"datapass, wheel","name":"datapass"},"targetID":null,"user":{"authenticationMethod":"SIMPLE","groups":"","name":"DO"},"writeMode":"Intrinsic"}                   | Thu Mar 12 16:30:13 CET 2020  | Thu Mar 12 16:30:13 CET 2020  |
| select * from LoZpostgresql.customer LIMIT 10                 | SUCCESS  | {"dataUsedForSchemaInference":0,"enforcedDataElement(s)":0,"ignoredPassport(s)":0,"lookupTableComputed":0,"lookupTableFromDFSCache":0,"lookupTableFromInMemoryCache":0,"numberOfChainedDEK(s)ForEnforcement":0,"numberOfChainedDEK(s)ForProtection":0,"numberOfKEK(s)ForProtection":0,"numberOfKEK(s)ForUnprotection":0,"numberOfLocalDEK(s)ForEnforcement":0,"numberOfLocalDEK(s)ForProtection":0,"numberOfOneTimeDEK(s)ForProtection":0,"numberOfQueryDEK(s)ForProtection":0,"numberOfSharedDEK(s)ForProtection":0,"protectedDataElement(s)":0,"unprotectedDataElement(s)":0}          | {"effectiveSenderUID":"SC1.DO","effectiveTargetUID":"SC1.DO","effectiveTrustZoneUIDs":"[SC1.DO]","failSilently":false,"mode":"Enforcement","permissions":"[]","senderID":null,"serviceUser":{"authenticationMethod":"SIMPLE","groups":"datapass, wheel","name":"datapass"},"targetID":null,"user":{"authenticationMethod":"SIMPLE","groups":"","name":"DO"},"writeMode":"Intrinsic"}                   | Thu Mar 12 16:25:07 CET 2020  | Thu Mar 12 16:25:07 CET 2020  |
+---------------------------------------------------------------+----------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------+-------------------------------+--+
10 rows selected (17.044 seconds)
Beeline version 1.2.1 by Apache Hive
Closing: 0: jdbc:hive2://10.3.58.108:10010
```

As you can see, we can get usefull information including the following:
* Why:
* What:
* How:
* When:
* By who:

## 2. Internal Audit Architecture
IBM Data Privacy Passports plays a critical roles enforcing/protecting the data. For your information, IBM Data Privacy Passports generates multiple fine logs in order to capture:
* executed queries
* emited events and incidents
* abbends
* error of processes

There is a full hierarchy of logs that is generated in the background. Such logs can be used as evidence in case of a fine investigation.
![alt-text](https://github.com/guikarai/IBMDPP/blob/master/audit-trail.png?raw=true)

## 3. Thank you
:clap: :metal: Congratulations! You did it, you just finished the IBM Data Privacy Applied Hands-on lab.

If you need to go deeper, do not hesitate to contact me: :email: guillaume_hoareau@fr.ibm.com
